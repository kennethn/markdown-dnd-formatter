$if(onecolumn)$
\documentclass[10pt,twoside]{article}
$else$
\documentclass[10pt,twocolumn,twoside]{article}
$endif$

% =========================
% 1. Packages
% =========================

% Font and encoding
\usepackage{microtype}
\usepackage{soul}            % for underlines
\usepackage[normalem]{ulem}  % prevents soul/ulem conflicts
% \usepackage{fontawesome5}
\usepackage{fontspec}
\usepackage[document]{ragged2e}
\usepackage[none]{hyphenat}
\usepackage{parskip}
\usepackage{needspace}
\usepackage{amssymb}
\usepackage{contour}
\usepackage{xfp}
\usepackage{fontawesome7}

% Hyperlinks (no colors)
\usepackage[hidelinks]{hyperref}
\usepackage{xcolor}

% Page layout
\usepackage[paper=letterpaper,top=0.35in,bottom=0.75in,left=0.35in,right=0.35in]{geometry}
\usepackage{titlesec}
\usepackage{etoolbox}

% Page numbering and headers/footers
\usepackage{fancyhdr}

% Lists
\usepackage{enumitem}

% Tables
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{array}
\usepackage{multirow}
\usepackage{colortbl}
\renewcommand{\arraystretch}{1.15}

% Colored boxes
\usepackage[most]{tcolorbox}

% Graphics
\usepackage{graphicx}

% =========================
% 2. Global Settings
% =========================

\RaggedRight
\setlength{\parskip}{8pt} % flexible ~20pt spacing
\setlength{\parindent}{0pt} % no indent for first lines
\setlength{\columnsep}{24pt}

\pagestyle{fancy}
\raggedbottom

% =========================
% 3. Font Configuration
% =========================

% Base font size for calculations
\newcommand{\basefontsize}{10}

% Main document font
\setmainfont{Atkinson Hyperlegible Next}[Ligatures=TeX]

% Specialized font families
\newfontfamily\blockquoteFont{Atkinson Hyperlegible Next}[
  Ligatures=TeX,
  BoldFont={Atkinson Hyperlegible Next SemiBold},
  BoldItalicFont={Atkinson Hyperlegible Next SemiBold Italic},
  Scale=0.9
]

\newfontfamily\headerfontbold{Atkinson Hyperlegible Next Bold}[Ligatures=TeX]
\newfontfamily\headerfont{Atkinson Hyperlegible Next SemiBold}[Ligatures=TeX]

\newfontfamily\monsterFont{Atkinson Hyperlegible Next}[
  Ligatures=TeX,
  Scale=0.85,
  BoldFont={Atkinson Hyperlegible Next SemiBold},
  BoldItalicFont={Atkinson Hyperlegible Next SemiBold Italic}
]

% Special purpose fonts
\newfontfamily\emojifont[Renderer=HarfBuzz]{NotoColorEmoji.ttf}
\setmonofont{Atkinson Hyperlegible Mono}[
  Contextuals=Alternate,
  Scale=MatchLowercase
]


% =========================
% 4. Typography and Sizing
% =========================

% Spacing control for section breaks
\newcommand{\stickysection}{\needspace{3\baselineskip}}
\newcommand{\stickysubsection}{\needspace{3\baselineskip}}
\newcommand{\stickysubsubsection}{\needspace{3\baselineskip}}

% Font size calculations based on base size
\newcommand{\sectionsize}{\fontsize{\fpeval{\basefontsize * 1.36}pt}{\fpeval{\basefontsize * 1.54}pt}\selectfont}
\newcommand{\subsectionsize}{\fontsize{\fpeval{\basefontsize * 1.18}pt}{\fpeval{\basefontsize * 1.36}pt}\selectfont}
\newcommand{\subsubsectionsize}{\fontsize{\fpeval{\basefontsize * 1.09}pt}{\fpeval{\basefontsize * 1.27}pt}\selectfont}
\newcommand{\paragraphsize}{\fontsize{\fpeval{\basefontsize * 1.045}pt}{\fpeval{\basefontsize * 1.18}pt}\selectfont}
\newcommand{\subparagraphsize}{\fontsize{\fpeval{\basefontsize * 1.0}pt}{\fpeval{\basefontsize * 1.18}pt}\selectfont}

\renewcommand{\ULdepth}{0.5ex}  % adjust this value to move the underline
\renewcommand{\ULthickness}{0.03em}  % underline thickness

\linespread{1.0} % default line spacing

% =========================
% 5. Color Scheme
% =========================

% Primary colors
\definecolor{sectioncolor}{HTML}{d20f39}     % Main red theme
\definecolor{keywordcolor}{HTML}{1E66F5}     % Keyword highlighting
\definecolor{highlightcolor}{HTML}{f5e0dc}   % Light gray background
\definecolor{highlightborder}{HTML}{1E66F5}  % Border for highlights
\definecolor{tableheadercolor}{HTML}{d20f39} % Table header background

% Callout box colors
\definecolor{encountercolor}{HTML}{eba0ac}   % Red for encounters
\definecolor{encounterborder}{HTML}{000000}  % White borders
\definecolor{monstercolor}{HTML}{d20f39}     % Red for monster blocks
\definecolor{imagecolor}{HTML}{89b4fa}       % Blue for images
\definecolor{imageborder}{HTML}{000000}      % White borders
\definecolor{remembercolor}{HTML}{f9e2af}    % Yellow for reminders
\definecolor{rememberborder}{HTML}{000000}   % Black borders
\definecolor{musiccolor}{HTML}{a6e3a1}       % Green for music

% Highlighted text
\sethlcolor{highlightcolor}

% =========================
% 6. List and Text Control
% =========================

% Widow/orphan control for lists
\makeatletter
\newcommand{\ListWidowControl}{%
  \clubpenalty=\@M
  \widowpenalty=\@M
  \displaywidowpenalty=\@M
  \clubpenalties 2 \@M \@M
  \widowpenalties 2 \@M \@M
  \interlinepenalty=100
}
\AtBeginEnvironment{itemize}{\ListWidowControl}
\AtBeginEnvironment{enumerate}{\ListWidowControl}
\makeatother

% List spacing configuration
\setlist[itemize]{itemsep=4pt, topsep=1pt, parsep=0pt, partopsep=0pt}

% Pandoc tightlist compatibility
\providecommand{\tightlist}{%
  \setlength{\itemsep}{4pt}%
  \setlength{\topsep}{1pt}%
  \setlength{\parsep}{0pt}%
  \setlength{\parskip}{0pt}%
  \setlength{\partopsep}{0pt}%
}

% Table rules spacing
\setlength{\aboverulesep}{0pt}
\setlength{\belowrulesep}{0pt}

% Prevent orphaned lists
\BeforeBeginEnvironment{itemize}{\needspace{1\baselineskip}}
\BeforeBeginEnvironment{enumerate}{\needspace{1\baselineskip}}

% =========================
% 7. Section Formatting
% =========================

% Section title formats
\titleformat{\section}[block]
  {\stickysection\sectionsize\color{sectioncolor}\headerfontbold}
  {}{0pt}{}

\titleformat{\subsection}[block]
  {\stickysubsection\subsectionsize\color{sectioncolor}\headerfontbold}
  {}{0pt}{}
  [\hrule height 1pt]

\titleformat{\subsubsection}[block]
  {\stickysubsubsection\subsubsectionsize\color{sectioncolor}\headerfont}
  {}{0pt}{}
  [\hrule height 0.5pt]

\titleformat{\paragraph}[block]
  {\stickysubsubsection\paragraphsize\color{sectioncolor}\headerfont}
  {}{0pt}{}

% Section spacing
\titlespacing*{\section}      {0pt}{1.5\baselineskip}{0.5\baselineskip}
\titlespacing*{\subsection}   {0pt}{1.25\baselineskip}{0.4\baselineskip}
\titlespacing*{\subsubsection}{0pt}{1.0\baselineskip}{0.3\baselineskip}
\titlespacing*{\paragraph}    {0pt}{0.75\baselineskip}{0.3\baselineskip}
\titlespacing*{\subparagraph} {0pt}{0.5\baselineskip}{0.25\baselineskip}

% =========================
% 8. Page Layout and Pagination
% =========================

% Header and footer setup
\fancyhf{}
\fancyfoot[LE,RO]{\color{sectioncolor}\textbf{\thepage}}
\fancyfoot[LO,RE]{\color{sectioncolor}\staticleftmark}
\renewcommand{\headrulewidth}{0pt}

% Custom colored footer rule
\makeatletter
\renewcommand{\footrule}{%
  \color{sectioncolor}\hrule\@height 1pt\@width\headwidth\vskip2pt
}
\makeatother
\pagestyle{fancy}
\setlength{\footskip}{28pt}

% Penalty settings for better page breaks
\clubpenalty=10000
\widowpenalty=10000
\brokenpenalty=4991
\predisplaypenalty=10000
\postdisplaypenalty=1549
\displaywidowpenalty=1602

% Quote environment penalties
\AtBeginEnvironment{quote}{%
  \clubpenalty=10000
  \widowpenalty=10000
}

\AtBeginEnvironment{quotation}{%
  \clubpenalty=10000
  \widowpenalty=10000
}

% =========================
% 9. Graphics and Media
% =========================

% Image sizing defaults
\setkeys{Gin}{width=0.48\textwidth, keepaspectratio}
\providecommand{\maxwidth}{\linewidth}
\providecommand{\maxheight}{0.9\textheight}
\providecommand{\pandocbounded}[1]{#1}

% =========================
% 10. Custom Environments
% =========================

% D&D-style blockquote environment
\renewenvironment{quote}{%
  \begingroup
  \setlength{\parindent}{1em}
  \linespread{1.0}
  \begin{tcolorbox}[myquote,
    before upper={%
      \let\textbf\oldtextbf
      \setlength{\parindent}{1.5em}
      \setlength{\parskip}{0pt}
      \noindent
    }
  ]
}{%
  \end{tcolorbox}
  \endgroup
}

% Blockquote box styling
\tcbset{myquote/.style={
  breakable,
  enhanced,
  colback={highlightcolor},
  boxrule=0pt,
  arc=0pt,
  left=6pt,
  right=6pt,
  top=6pt,
  bottom=4pt,
  boxsep=4pt,
  before skip=12pt,
  after skip=12pt,
  borderline west={2pt}{0pt}{highlightborder},
  borderline east={2pt}{0pt}{highlightborder},
  sharp corners,
  fontupper=\blockquoteFont,
  before upper={%
    \setlength{\parskip}{4pt}
    \setlength{\baselineskip}{10pt}
  }
}}

% =========================
% 11. Document Content
% =========================

\begin{document}
\vspace*{-\topskip}
$body$

\end{document}
